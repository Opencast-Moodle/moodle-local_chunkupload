{"version":3,"sources":["../src/chunkupload.js"],"names":["init","elementid","acceptedTypes","maxBytes","wwwroot","chunksize","browsetext","wwwRoot","chunkSize","fileinput","filename","progress","progressicon","deleteicon","token","val","parentelem","next","find","change","reset","file","get","files","fileextension","name","indexOf","splits","split","length","toLowerCase","Array","notifyError","key","component","param","size","text","startUpload","on","event","params","id","xhr","XMLHttpRequest","open","$","send","stopPropagation","end","start","slice","upload","onprogress","e","setProgress","loaded","onreadystatechange","readyState","status","response","JSON","parse","responseText","error","proceedUpload","setRequestHeader","onerror","notification","alert","total","css","prop","errorstring","done","s","fail","exception"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manage the upload in chunks.\n *\n * @module    local_chunkupload\n * @copyright  2020 Justus Dieckmann WWU\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport $ from 'jquery';\nimport {get_strings as getStrings} from 'core/str';\nimport notification from 'core/notification';\n\n/**\n * Init\n * @param {String} elementid string The id of the input element\n * @param {String|String[]} acceptedTypes The accepted Types\n * @param {int} maxBytes The maximal allowed amount of bytes\n * @param {string} wwwroot The wwwroot\n * @param {int} chunksize The chunksize in bytes\n * @param {string} browsetext Text to display when no file is uploaded.\n */\nexport function init(elementid, acceptedTypes, maxBytes, wwwroot, chunksize, browsetext) {\n    let wwwRoot,\n        chunkSize;\n\n    let fileinput, filename, progress, progressicon, deleteicon;\n\n    let token;\n\n    fileinput = $('#' + elementid + \"_file\");\n    token = $('#' + elementid).val();\n    let parentelem = fileinput.next();\n    filename = parentelem.find('.chunkupload-filename');\n    progress = parentelem.find('.chunkupload-progress');\n    progressicon = parentelem.find('.chunkupload-icon');\n    deleteicon = parentelem.next();\n    wwwRoot = wwwroot;\n    chunkSize = chunksize;\n    fileinput.change(() => {\n        reset();\n        let file = fileinput.get(0).files[0];\n        let fileextension = \".\";\n        if (file.name.indexOf(\".\") !== -1) {\n            let splits = file.name.split(\".\");\n            fileextension = \".\" + splits[splits.length - 1].toLowerCase();\n        }\n        if (!(acceptedTypes === '*' ||\n            acceptedTypes instanceof Array && (acceptedTypes.indexOf(fileextension) !== -1 || acceptedTypes.indexOf('*') !== -1))) {\n            fileinput.val(null);\n            notifyError({key: 'invalidfiletype', component: 'core_repository', param: fileextension});\n            return;\n        } else if (maxBytes !== -1 && file.size > maxBytes) {\n            fileinput.val(null);\n            notifyError({key: 'errorpostmaxsize', component: 'core_repository'});\n            return;\n        }\n        filename.text(file.name);\n        startUpload(file);\n    });\n\n    deleteicon.on('click', (event) => {\n        reset();\n        let params = {\n            id: token\n        };\n        let xhr = new XMLHttpRequest();\n        xhr.open('post', wwwRoot + \"/local/chunkupload/deleteupload_ajax.php?\" + $.param(params));\n        xhr.send(null);\n        filename.text(browsetext);\n        fileinput.val(null);\n        event.stopPropagation();\n    });\n\n    /**\n     * Start the Upload\n     * @param {File} file The File to upload.\n     */\n    function startUpload(file) {\n        let end = chunkSize < file.size ? chunkSize : file.size;\n        let params = {\n            start: 0,\n            end: end,\n            length: file.size,\n            filename: file.name,\n            id: token\n        };\n        let slice = file.slice(0, end);\n        let xhr = new XMLHttpRequest();\n        xhr.open('post', wwwRoot + \"/local/chunkupload/startupload_ajax.php?\" + $.param(params));\n        xhr.upload.onprogress = (e) => {\n            setProgress(e.loaded, file.size);\n        };\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4) {\n                if (xhr.status === 200) {\n                    let response = JSON.parse(xhr.responseText);\n                    if (response.error !== undefined) {\n                        notifyError(response.error);\n                    } else {\n                        if (end < file.size) {\n                            proceedUpload(file, chunkSize);\n                        }\n                    }\n                }\n            }\n        };\n        xhr.setRequestHeader('Content-Type', 'application/octet-stream');\n        xhr.send(slice);\n    }\n\n    /**\n     * Proceed the upload\n     * @param {File} file\n     * @param {int} start from where to proceed the upload.\n     */\n    function proceedUpload(file, start) {\n        let end = start + chunkSize < file.size ? start + chunkSize : file.size;\n        let params = {\n            start: start,\n            end: end,\n            id: token\n        };\n        let slice = file.slice(start, end);\n        let xhr = new XMLHttpRequest();\n        xhr.open('post', wwwRoot + \"/local/chunkupload/proceedupload_ajax.php?\" + $.param(params));\n        xhr.upload.onprogress = (e) => {\n            setProgress(e.loaded + start, file.size);\n        };\n        xhr.onreadystatechange = () => {\n            if (xhr.readyState === 4) {\n                if (xhr.status === 200) {\n                    let response = JSON.parse(xhr.responseText);\n                    if (response.error !== undefined) {\n                        notifyError(response.error);\n                    } else {\n                        if (end < file.size) {\n                            proceedUpload(file, end);\n                        }\n                    }\n                }\n            }\n        };\n        xhr.onerror = () => {\n            reset();\n            // Doesn't make sense to try to fetch strings when having internet problems.\n            notification.alert(\"Error\", \"Failure while uploading!\", \"Ok\");\n        };\n        xhr.setRequestHeader('Content-Type', 'application/octet-stream');\n        xhr.send(slice);\n    }\n\n    /**\n     * Resets the Progress and the Filepicker name.\n     */\n    function reset() {\n        setProgress(0, 1);\n        filename.text(\"\");\n    }\n\n    /**\n     * Sets the progressbar\n     * @param {int} loaded\n     * @param {int} total\n     */\n    function setProgress(loaded, total) {\n        if (loaded === total) {\n            // Hide progressbar on finish.\n            progress.css('width', '0');\n        } else {\n            progress.css('width', loaded * 100 / total + \"%\");\n        }\n        progressicon.prop('hidden', loaded !== total);\n        deleteicon.prop('hidden', loaded !== total);\n    }\n\n    /**\n     * Notify error\n     * @param {object|string} errorstring Either Object as accepted by getString, or a string, to describe the error.\n     */\n    function notifyError(errorstring) {\n        reset();\n        if (typeof errorstring === \"string\") {\n            getStrings([\n                {key: 'error'},\n                {key: 'ok'},\n            ]).done(function(s) {\n                    notification.alert(s[0], errorstring, s[1]);\n                }\n            ).fail(notification.exception);\n        } else {\n            getStrings([\n                {key: 'error'},\n                errorstring,\n                {key: 'ok'},\n            ]).done(function(s) {\n                    notification.alert(s[0], s[1], s[2]);\n                }\n            ).fail(notification.exception);\n        }\n    }\n}"],"file":"chunkupload.min.js"}